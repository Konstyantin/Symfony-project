<?php

namespace CarBundle\Repository;
use CarBundle\Entity\Car;

/**
 * CarRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class CarRepository extends \Doctrine\ORM\EntityRepository
{
    /**
     * Get cars by model
     *
     * Get car list item by model item
     *
     * @param string $model
     * @return array
     */
    public function getCarsByModel(string $model)
    {
        $query = $this->createQueryBuilder('c')
            ->join('CarBundle:Model', 'm', 'WITH', 'c.model = m.id')
            ->where('m.slug =:model')
            ->setParameter('model', $model)
            ->getQuery();

        return $query->getResult();
    }

    /**
     * Get item model car
     *
     * Get car item by model name and car item name
     *
     * @param string $model
     * @param string $carName
     * @return array
     */
    public function getItemModelCar(string $model, string $carName)
    {
        $query = $this->createQueryBuilder('c')
            ->join('CarBundle:Model', 'm', 'WITH', 'c.model = m.id')
            ->where('m.slug =:model')
            ->andwhere('c.slug =:carName')
            ->setParameter('model', $model)
            ->setParameter('carName', $carName)
            ->getQuery();


        return $query->getOneOrNullResult();
    }

    /**
     * Get available car list
     *
     * Get car items list which is available
     *
     * @return array
     */
    public function getAvailableCarList()
    {
        $query = $this->createQueryBuilder('c')
            ->join('CarBundle:Model', 'm', 'WITH', 'c.model = m.id')
            ->where('c.available = 1')
            ->getQuery();

        return $query->getResult();
    }

    /**
     * Get car by user id
     *
     * Get car list query by user id
     *
     * @param $userId int|bool
     * @return \Doctrine\ORM\QueryBuilder
     */
    public function getCarsByUserId($userId = null)
    {
        $query = $this->createQueryBuilder('car');
        $query = ($userId) ? $query->join('UserBundle:UserCar', 'user_car', 'WITH', 'car.id = user_car.car')
            ->where('user_car.user =:userId')
            ->setParameter('userId', $userId) : $query;

        $query->orderBy('car.id', 'ASC');

        return $query;
    }

    /**
     * Get car item by name
     *
     * Get car item by passer name param
     *
     * @param string $name
     * @return mixed
     */
    public function getCarItemByName(string $name)
    {
        $query = $this->createQueryBuilder('car')
            ->where('car.name =:name')
            ->setParameter('name', $name)
            ->getQuery();

        return $query->getOneOrNullResult();
    }

    /**
     * Get car item
     *
     * Get first existed car item record
     *
     * @return Car
     */
    public function getFirstCarItem()
    {
        $query = $this->createQueryBuilder('car')
            ->setMaxResults(1)
            ->getQuery();

        return $query->getSingleResult();
    }

    /**
     * Search car by name
     *
     * Search car collection by passed car name param
     *
     * @param string $name
     * @return array
     */
    public function searchCarByName(string $name)
    {
        $query = $this->createQueryBuilder('car')
            ->leftJoin('car.imageLogo', 'image_logo')
            ->select('car.name', 'car.id', 'car.slug')
            ->addSelect('image_logo.id as imageId', 'image_logo.providerReference')
            ->where('car.name LIKE :name')
            ->setParameter('name', '%' . $name . '%')
            ->getQuery();

        return $query->getResult();
    }

    /**
     * Search car
     *
     * Get car list collection
     *
     * @return array
     */
    public function searchCar()
    {
        $query = $this->createQueryBuilder('car')
            ->leftJoin('car.imageLogo', 'image_logo')
            ->select('car.name', 'car.id', 'car.slug')
            ->addSelect('image_logo.id as imageId', 'image_logo.providerReference')
            ->getQuery();

        return $query->getResult();
    }
}
